<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Guru Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        /* CSS SAMA SEPERTI SEBELUMNYA, TAPI DISEDERHANAKAN UNTUK TABEL BARU */
        body { font-family: 'Poppins', sans-serif; background: #f0f2f5; margin: 0; color: #333; }
        
        /* LOGIN */
        .login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 999;
            display: flex; justify-content: center; align-items: center;
        }
        .login-box { background: white; padding: 40px; border-radius: 12px; text-align: center; width: 300px; }
        input { padding: 10px; width: 90%; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; }
        .btn-blue { background: #007bff; }
        .btn-green { background: #28a745; }
        .btn-red { background: #dc3545; }
        .btn-red:hover { background: #c82333; }

        /* DASHBOARD */
        #dashboardContent { display: none; max-width: 1100px; margin: 0 auto; padding: 20px; }
        .header-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        /* TABEL */
        .table-container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #343a40; color: white; }
        tr:hover { background: #f8f9fa; }

        /* TOMBOL REVIEW */
        .btn-review {
            text-decoration: none;
            background: #17a2b8; color: white;
            padding: 8px 12px; border-radius: 5px;
            font-size: 0.9rem; transition: 0.3s;
            display: inline-block;
        }
        .btn-review:hover { background: #138496; }
    </style>
</head>
<body>

    <div id="loginOverlay" class="login-overlay">
        <div class="login-box">
            <h2>Akses Guru</h2>
            <input type="password" id="pinInput" placeholder="PIN (1234)">
            <button class="btn btn-blue" onclick="bukaPintu()">Masuk</button>
            <p id="pesanError" style="color:red; display:none; margin-top:10px;">PIN Salah!</p>
        </div>
    </div>

    <div id="dashboardContent">
        <div class="header-area">
            <h1>Rekapitulasi Siswa</h1>
            <div>
                <button class="btn btn-green" onclick="ambilDataSupabase()">
                    <i class="fa-solid fa-rotate"></i> Refresh
                </button>
            </div>
        </div>

        <div class="table-container">
            <p id="statusKoneksi">Mengambil data...</p>
            <table id="mainTable">
                <thead>
                    <tr>
                        <th>Nama Siswa</th>
                        <th>Waktu Submit</th>
                        <th>Skor (Benar/Salah)</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="tabelBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        // 1. SETUP SUPABASE
        const supabaseUrl = 'https://cydgsvqybhhfedoazfok.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN5ZGdzdnF5YmhoZmVkb2F6Zm9rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4NDc5ODAsImV4cCI6MjA4MzQyMzk4MH0.4p4It2z4qVyLNydXwNdOHx9es7R5zAbB-EevFZVk5Y8';

        // 2. FUNGSI LOGIN
        function bukaPintu() {
            if(document.getElementById('pinInput').value.trim() === '1234') {
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';
                ambilDataSupabase();
            } else {
                document.getElementById('pesanError').style.display = 'block';
            }
        }

        // 3. FUNGSI AMBIL DATA
        async function ambilDataSupabase() {
            const statusText = document.getElementById('statusKoneksi');
            statusText.textContent = "Sedang memuat data...";
            
            try {
                const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                // Ambil semua jawaban
                const { data, error } = await supabase
                    .from('student_answers')
                    .select('*')
                    .order('id', { ascending: false });

                if (error) throw error;
                processAndRender(data);
                statusText.textContent = "Data diperbarui: " + new Date().toLocaleTimeString();

            } catch (err) {
                console.error(err);
                statusText.textContent = "Gagal memuat data.";
            }
        }

        // 4. LOGIKA PENGELOMPOKAN (GROUPING)
        function processAndRender(data) {
            const tableBody = document.getElementById('tabelBody');
            tableBody.innerHTML = "";

            if (data.length === 0) {
                tableBody.innerHTML = "<tr><td colspan='4'>Belum ada data siswa.</td></tr>";
                return;
            }

            // Object untuk menampung ringkasan per siswa
            const students = {};

            data.forEach(row => {
                const name = row.student_name;
                
                // Jika nama belum ada di daftar, buat entry baru
                if (!students[name]) {
                    students[name] = {
                        name: name,
                        lastSubmit: row.timestamp,
                        correctCount: 0,
                        wrongCount: 0
                    };
                }
                
                // Hitung skor
                if (row.is_correct) students[name].correctCount++;
                else students[name].wrongCount++;
            });

            // Loop object students dan buat baris tabel
            Object.values(students).forEach(student => {
                const tr = document.createElement('tr');
                const time = new Date(student.lastSubmit).toLocaleString('id-ID');
                
                // --- INI BAGIAN LINK "MAGIC" NYA ---
                // Kita encode nama siswa agar aman di URL (misal spasi jadi %20)
                const safeName = encodeURIComponent(student.name);
                const reviewLink = `index.html?siswa=${safeName}`;

                tr.innerHTML = `
                    <td style="font-weight:bold;">${student.name}</td>
                    <td>${time}</td>
                    <td>
                        <span style="color:green; font-weight:bold;">${student.correctCount} Benar</span> / 
                        <span style="color:red; font-weight:bold;">${student.wrongCount} Salah</span>
                    </td>
                    <td>
                        <a href="${reviewLink}" target="_blank" class="btn-review">
                            <i class="fa-solid fa-file-signature"></i> Lihat LKPD
                        </a>
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        }
    </script>
</body>
</html>